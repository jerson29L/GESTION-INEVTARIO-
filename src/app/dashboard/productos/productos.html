<div class="px-6 pt-8 pb-10 max-w-[1800px] mx-auto">
  <header class="flex items-center justify-between mb-10">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Gestión de Productos</h1>
      <p class="text-gray-500 mt-1">Administra tu catálogo de productos</p>
    </div>
    <div class="flex gap-3">
      <button (click)="openNewModal()" class="flex items-center bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-lg shadow transition">
        <lucide-icon name="Plus" class="h-4 w-4 mr-2"></lucide-icon>
        Nuevo Producto
      </button>
    </div>
  </header>

  <!-- Mensajes de éxito y error -->
  <div *ngIf="showSuccessMessage" class="mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg flex items-center">
    <lucide-icon name="CheckCircle" class="h-5 w-5 mr-2"></lucide-icon>
    <span>Operación completada exitosamente</span>
    <button (click)="clearMessages()" class="ml-auto text-green-500 hover:text-green-700">
      <lucide-icon name="X" class="h-4 w-4"></lucide-icon>
    </button>
  </div>

  <div *ngIf="showErrorMessage" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] mb-6 p-6 bg-red-100 border-2 border-red-400 text-red-800 rounded-lg shadow-2xl max-w-2xl">
    <div class="flex items-center mb-2">
      <lucide-icon name="AlertTriangle" class="h-6 w-6 mr-3 text-red-600"></lucide-icon>
      <h3 class="text-lg font-bold text-red-800">CAMPOS OBLIGATORIOS FALTANTES</h3>
      <button (click)="clearMessages()" class="ml-auto text-red-500 hover:text-red-700">
        <lucide-icon name="X" class="h-5 w-5"></lucide-icon>
      </button>
    </div>
    <div class="bg-red-50 p-3 rounded border-l-4 border-red-500">
      <p class="font-medium">{{ errorMessage }}</p>
      <p class="text-sm mt-1 text-red-600">Por favor, complete todos los campos marcados con * antes de continuar.</p>
    </div>
  </div>

  <!-- Pantalla de carga -->
  <div *ngIf="isLoading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
      <lucide-icon name="Loader2" class="h-6 w-6 animate-spin mr-3"></lucide-icon>
      <span>Procesando...</span>
    </div>
  </div>

  <!-- Filtros -->
  <div class="bg-white shadow-md rounded-xl mb-6 p-6">
    <div class="flex flex-col md:flex-row gap-4 items-end">
      <div class="flex-1">
        <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
        <div class="relative">
          <lucide-icon name="Search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></lucide-icon>
          <input
            type="text"
            placeholder="Buscar por nombre, marca o código"
            [(ngModel)]="searchTerm"
            class="input input-bordered w-full pl-10 py-2.5 text-base border-gray-300 rounded-lg"
          />
        </div>
      </div>

      <div class="w-full md:w-64">
        <label class="block text-sm font-medium text-gray-700 mb-2">Categoría</label>
        <select class="select select-bordered w-full py-2.5 text-base border-gray-300 rounded-lg" [(ngModel)]="selectedCategory">
          <option value="all">Todas las categorías</option>
          <option *ngFor="let category of categoriasDisponibles" [value]="category.nombre">
            {{ category.nombre }}
          </option>
        </select>
      </div>

      <div class="w-full md:w-64">
        <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
        <select class="select select-bordered w-full py-2.5 text-base border-gray-300 rounded-lg">
          <option value="all">Todos los estados</option>
          <option value="stock">En Stock</option>
          <option value="poco">Poco Stock</option>
          <option value="sin">Sin Stock</option>
        </select>
      </div>

     
    </div>
  </div>

  <!-- Tabla de Productos -->
  <div class="bg-white shadow-md rounded-xl overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Producto</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Marca</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Categoría</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Stock</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Precio</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Lote</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <tr *ngFor="let product of filteredProducts" class="hover:bg-gray-50 transition">
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0">
                  <lucide-icon name="Package" class="h-5 w-5 text-gray-400"></lucide-icon>
                </div>
                <div>
                  <div class="font-semibold text-gray-900">{{ product.name }}</div>
                  <div class="text-sm text-gray-500">{{ product.sku }}</div>
                </div>
              </div>
            </td>

            <td class="px-6 py-4">
              <span class="text-gray-900">{{ product.provider }}</span>
            </td>

            <td class="px-6 py-4">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                <!-- CAMBIO: Se muestra el nombre de la categoría desde la nueva propiedad 'categoryName' -->
                {{ product.categoryName }}
              </span>
            </td>

            <td class="px-6 py-4">
              <span class="font-medium" [ngClass]="getStockColor(product.stock)">{{ product.stock }}</span>
            </td>

            <td class="px-6 py-4">
              <span class="text-gray-900 font-semibold">S/ {{ product.price }}</span>
            </td>

            <td class="px-6 py-4">
              <!-- CAMBIO: Se usa el ID formateado 'id_display' para el lote -->
              <span class="text-gray-600 text-sm">LOT-2024-{{ product.id_display }}</span>
            </td>

            <td class="px-6 py-4">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                [ngClass]="{
                  'bg-green-100 text-green-800': (product.estado_stock_display || getStockStatus(product.stock)) === 'Disponible',
                  'bg-yellow-100 text-yellow-800': (product.estado_stock_display || getStockStatus(product.stock)) === 'Pocas unidades',
                  'bg-red-100 text-red-800': (product.estado_stock_display || getStockStatus(product.stock)) === 'Sin Stock'
                }">
                {{ product.estado_stock_display || getStockStatus(product.stock) }}
              </span>
            </td>

            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <button (click)="openEditModal(product)" 
                  class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition border border-blue-200">
                  <lucide-icon name="Edit" class="h-4 w-4"></lucide-icon>
                </button>
                <button (click)="openDeleteModal(product)" 
                  class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition border border-red-200">
                  <lucide-icon name="Trash2" class="h-4 w-4"></lucide-icon>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Mensaje cuando no hay productos -->
    <div *ngIf="filteredProducts.length === 0" class="text-center py-16">
      <lucide-icon name="Package" class="h-16 w-16 text-gray-300 mx-auto mb-4"></lucide-icon>
      <h3 class="text-lg font-semibold text-gray-800 mb-2">No se encontraron productos</h3>
      <p class="text-gray-500 mb-4">Intenta ajustar tus filtros o agrega un nuevo producto.</p>
      <button (click)="openNewModal()" class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg shadow transition">
        <lucide-icon name="Plus" class="h-4 w-4 mr-2"></lucide-icon>
        Agregar Producto
      </button>
    </div>
  </div>

  <!-- Modal de confirmación para eliminar -->
  <div *ngIf="showDeleteModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-scale-in">
      <div class="p-8 border-b flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-800">Confirmar Eliminación</h2>
        <button (click)="closeDeleteModal()" class="btn btn-sm btn-circle btn-ghost">
          <lucide-icon name="X"></lucide-icon>
        </button>
      </div>
      <div class="p-8">
        <div class="flex items-center mb-6">
          <lucide-icon name="AlertTriangle" class="h-12 w-12 mr-4 text-red-500"></lucide-icon>
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">¿Eliminar Producto?</h3>
            <p class="text-gray-600">Esta acción no se puede deshacer.</p>
          </div>
        </div>
        <div class="bg-red-50 p-4 rounded-lg mb-6">
          <p class="font-medium text-red-800">{{ productToDelete?.name }}</p>
          <p class="text-sm text-red-600 mt-1">Código: {{ productToDelete?.sku }}</p>
          <p class="text-sm text-red-600">Precio: S/ {{ productToDelete?.price }}</p>
        </div>
        <div class="flex justify-end gap-4">
          <button (click)="closeDeleteModal()" class="btn btn-ghost">Cancelar</button>
          <button (click)="confirmDeleteProduct()" class="btn bg-red-600 hover:bg-red-700 text-white font-semibold px-5 py-2 rounded-lg shadow flex items-center transition">
            <lucide-icon name="Trash2" class="h-4 w-4 mr-2"></lucide-icon>
            Eliminar Producto
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal del formulario (Nuevo/Editar Producto) -->
  <div *ngIf="showFormModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl animate-scale-in max-h-[90vh] flex flex-col overflow-hidden">
      <div class="p-8 border-b flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-800">{{ selectedProduct ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
        <button (click)="closeModal()" class="btn btn-sm btn-circle btn-ghost">
          <lucide-icon name="X"></lucide-icon>
        </button>
      </div>

      <div class="p-8 overflow-y-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="space-y-5">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto *</label>
              <input type="text" [(ngModel)]="editingProduct.name" class="input input-bordered w-full py-3 text-base"
                [ngClass]="{'border-red-500': showErrorMessage && (!editingProduct.name || editingProduct.name.trim() === '')}"
                placeholder="Ingresa el nombre del producto" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Código de Producto *</label>
              <input type="text" [(ngModel)]="editingProduct.sku" class="input input-bordered w-full py-3 text-base"
                [ngClass]="{'border-red-500': showErrorMessage && (!editingProduct.sku || editingProduct.sku.trim() === '')}"
                placeholder="Código único del producto" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Categoría *</label>
              <!-- ======================= CAMBIO CLAVE AQUÍ ======================= -->
              <select 
                [(ngModel)]="editingProduct.idcategoria" 
                class="select select-bordered w-full py-3 text-base"
                [ngClass]="{'border-red-500': showErrorMessage && !editingProduct.idcategoria}">
                
                <option [ngValue]="null">Seleccionar categoría</option>
                
                <option *ngFor="let cat of categoriasDisponibles" [value]="cat.idcategoria">
                  {{ cat.nombre }}
                </option>
              </select>
              <!-- ================================================================ -->
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor *</label>
              <select [(ngModel)]="editingProduct.provider" class="select select-bordered w-full py-3 text-base"
                [ngClass]="{'border-red-500': showErrorMessage && (!editingProduct.provider || editingProduct.provider.trim() === '')}">
                <option value="">Seleccionar proveedor</option>
                <option *ngFor="let prov of proveedoresDisponibles" [value]="prov">
                  {{ prov }}
                </option>
              </select>
            </div>
          </div>

          <div class="space-y-5">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Precio (S/) *</label>
                <input type="number" [(ngModel)]="editingProduct.price" class="input input-bordered w-full py-3 text-base"
                  [ngClass]="{'border-red-500': showErrorMessage && (editingProduct.price === null || editingProduct.price === undefined || editingProduct.price < 0)}"
                  placeholder="Precio del producto" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Stock *</label>
                <input type="number" [(ngModel)]="editingProduct.stock" class="input input-bordered w-full py-3 text-base"
                  [ngClass]="{'border-red-500': showErrorMessage && (editingProduct.stock === null || editingProduct.stock === undefined || editingProduct.stock < 0)}"
                  placeholder="Cantidad en stock" />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Descripción *</label>
              <textarea [(ngModel)]="editingProduct.description" class="textarea textarea-bordered w-full py-3 text-base" rows="3"
                [ngClass]="{'border-red-500': showErrorMessage && (!editingProduct.description || editingProduct.description.trim() === '')}"
                placeholder="Descripción detallada del producto"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-4 p-8 border-t bg-gray-50">
        <button (click)="closeModal()" class="btn btn-ghost">Cancelar</button>
        <button (click)="saveProduct()" class="btn font-semibold px-5 py-2 rounded-lg shadow flex items-center transition"
          [ngClass]="{
            'bg-green-600 hover:bg-green-700 text-white': !showErrorMessage,
            'bg-red-500 hover:bg-red-600 text-white': showErrorMessage
          }">
          <lucide-icon [name]="showErrorMessage ? 'AlertCircle' : 'Save'" class="h-4 w-4 mr-2"></lucide-icon>
          {{ showErrorMessage ? 'Corregir Errores' : (selectedProduct ? 'Actualizar' : 'Guardar Producto') }}
        </button>
      </div>
    </div>
  </div>
</div>